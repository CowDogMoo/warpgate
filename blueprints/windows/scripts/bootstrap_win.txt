<powershell>
$ProgressPreference = 'SilentlyContinue'
$ErrorActionPreference = 'Stop'

Write-Host "Disabling anti-virus monitoring"
Set-MpPreference -DisableRealtimeMonitoring $true

Write-Host "Installing OpenSSH Client and Server"
Add-WindowsCapability -Online -Name OpenSSH.Client~~~~0.0.1.0
Add-WindowsCapability -Online -Name OpenSSH.Server~~~~0.0.1.0

Write-Host "Starting and configuring SSH server"
Start-Service sshd
Set-Service -Name sshd -StartupType 'Automatic'

Write-Host "Setting up firewall rules for SSH"
if (!(Get-NetFirewallRule -Name "OpenSSH-Server-In-TCP" -ErrorAction SilentlyContinue | Select-Object Name, Enabled)) {
  New-NetFirewallRule -Name 'OpenSSH-Server-In-TCP' -DisplayName 'OpenSSH Server (sshd)' -Enabled True -Direction Inbound -Protocol TCP -Action Allow -LocalPort 22
} else {
  Write-Output "Firewall rule 'OpenSSH-Server-In-TCP' already exists."
}

Write-Host "Fetching and installing the public key from EC2 instance metadata"
$keyPath = "$env:ProgramData\ssh\administrators_authorized_keys"
$keyUrl = "http://169.254.169.254/latest/meta-data/public-keys/0/openssh-key"
Invoke-WebRequest $keyUrl -OutFile $keyPath -UseBasicParsing

Write-Host "Disabling WinRM service"
Stop-Service WinRM
Set-Service -Name WinRM -StartupType Disabled
</powershell>
