---
name: Build and Publish Container Images
on:
  merge_group:
  workflow_dispatch:
    inputs:
      image:
        description: "Specific image to build (leave empty for all)"
        required: false
        type: string
  pull_request:
    paths:
      - "dockerfiles/**"
      - "Taskfile.yaml"
      - ".github/workflows/dockerfile-image-builder.yaml"
  push:
    branches: [main]
    paths:
      - "dockerfiles/**"
      - "Taskfile.yaml"
      - ".github/workflows/dockerfile-image-builder.yaml"

env:
  TASK_VERSION: 3.38.0
  TASK_X_REMOTE_TASKFILES: 1

concurrency:
  cancel-in-progress: true
  group: "${{ github.workflow }}-${{ github.ref }}"

permissions:
  id-token: write
  contents: read
  packages: write

jobs:
  discover-images:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Setup git repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

      - name: Install Task
        run: |
          sh -c "$(curl --location https://taskfile.dev/install.sh)" -- -d -b /usr/local/bin v${{ env.TASK_VERSION }}
          task --version

      - name: Discover images with Taskfile
        id: set-matrix
        env:
          INPUT_IMAGE: ${{ github.event.inputs.image }}
        run: |
          if [ -n "$INPUT_IMAGE" ]; then
            # Single image specified via workflow_dispatch
            echo "matrix=[\"$INPUT_IMAGE\"]" >> "$GITHUB_OUTPUT"
          else
            # Use Taskfile to discover images
            images=$(task images:discover | grep -v "Discovering" | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "matrix=$images" >> "$GITHUB_OUTPUT"
          fi

  build-and-push:
    name: Build ${{ matrix.image }}
    needs: discover-images
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        image: ${{ fromJson(needs.discover-images.outputs.matrix) }}
    steps:
      - name: Setup git repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

      - name: Install Task
        run: |
          sh -c "$(curl --location https://taskfile.dev/install.sh)" -- -d -b /usr/local/bin v${{ env.TASK_VERSION }}
          task --version

      - name: Setup QEMU
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3

      - name: Log in to the GitHub Container Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push ${{ matrix.image }} using Taskfile
        env:
          BUILDX_NO_DEFAULT_ATTESTATIONS: 1
        run: |
          task images:build IMAGE=${{ matrix.image }} PUSH=true
