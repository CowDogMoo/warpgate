---
name: Build and Publish Container Images
on:
  workflow_dispatch:
    inputs:
      image:
        description: "Specific image to build (leave empty for all)"
        required: false
        type: string
  pull_request:
    paths:
      - "dockerfiles/**"
      - ".github/workflows/dockerfile-image-builder.yaml"
  push:
    branches: [main]
    paths:
      - "dockerfiles/**"
      - ".github/workflows/dockerfile-image-builder.yaml"

concurrency:
  cancel-in-progress: true
  group: "${{ github.workflow }}-${{ github.ref }}"

permissions:
  id-token: write
  contents: read
  packages: write

jobs:
  discover-images:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Setup git repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Discover images with docker-bake.hcl
        id: set-matrix
        run: |
          if [ -n "${{ github.event.inputs.image }}" ]; then
            # Single image specified via workflow_dispatch
            echo "matrix=[\"${{ github.event.inputs.image }}\"]" >> $GITHUB_OUTPUT
          else
            # Find all directories with docker-bake.hcl
            images=$(find dockerfiles -mindepth 1 -maxdepth 1 -type d -exec test -f {}/docker-bake.hcl \; -exec basename {} \; | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "matrix=$images" >> $GITHUB_OUTPUT
          fi

  build-and-push:
    needs: discover-images
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        image: ${{ fromJson(needs.discover-images.outputs.matrix) }}
    steps:
      - name: Setup git repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Setup QEMU
        uses: docker/setup-qemu-action@29109295f81e9208d7d86ff1c6c12d2833863392 # v3

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3

      - name: Log in to the GitHub Container Registry
        uses: docker/login-action@184bdaa0721073962dff0199f1fb9940f07167d1 # v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push ${{ matrix.image }}
        uses: docker/bake-action@3acf805d94d93a86cce4ca44798a76464a75b88c # v6
        with:
          files: ./dockerfiles/${{ matrix.image }}/docker-bake.hcl
          provenance: false # Stop unknown/unknown images from being pushed
          push: true
          set: |
            *.platform=linux/amd64,linux/arm64
            *.args.REPO=ghcr.io/cowdogmoo/${{ matrix.image }}
            *.args.TAG=latest
