---
name: Build and Publish Container Images
on:
  workflow_dispatch:
    inputs:
      image:
        description: "Specific image to build (leave empty for all)"
        required: false
        type: string
  pull_request:
    paths:
      - "dockerfiles/**"
      - ".github/workflows/dockerfile-image-builder.yaml"
  push:
    branches: [main]
    paths:
      - "dockerfiles/**"
      - ".github/workflows/dockerfile-image-builder.yaml"

concurrency:
  cancel-in-progress: true
  group: "${{ github.workflow }}-${{ github.ref }}"

permissions:
  id-token: write
  contents: read
  packages: write

jobs:
  discover-images:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Setup git repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

      - name: Discover images with docker-bake.hcl
        id: set-matrix
        env:
          INPUT_IMAGE: ${{ github.event.inputs.image }}
        run: |
          if [ -n "$INPUT_IMAGE" ]; then
            # Single image specified via workflow_dispatch
            echo "matrix=[\"$INPUT_IMAGE\"]" >> "$GITHUB_OUTPUT"
          else
            # Find all directories with docker-bake.hcl
            images=$(find dockerfiles -mindepth 1 -maxdepth 1 -type d -exec test -f {}/docker-bake.hcl \; -exec basename {} \; | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "matrix=$images" >> "$GITHUB_OUTPUT"
          fi

  build-and-push:
    needs: discover-images
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        image: ${{ fromJson(needs.discover-images.outputs.matrix) }}
    steps:
      - name: Setup git repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

      - name: Setup QEMU
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3

      - name: Log in to the GitHub Container Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push ${{ matrix.image }}
        uses: docker/bake-action@5be5f02ff8819ecd3092ea6b2e6261c31774f2b4 # v6
        with:
          files: ./dockerfiles/${{ matrix.image }}/docker-bake.hcl
          provenance: false # Stop unknown/unknown images from being pushed
          push: true
          set: |
            *.platform=linux/amd64,linux/arm64
            *.args.REPO=ghcr.io/cowdogmoo/${{ matrix.image }}
            *.args.TAG=latest
